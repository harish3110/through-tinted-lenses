<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Introduction to NLP using Fastai | Through Tinted Lenses</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Introduction to NLP using Fastai" />
<meta name="author" content="Harish Vadlamani" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Implementing and decoding the revolutionary ULMFiT approach to train a language model on any downstream NLP task." />
<meta property="og:description" content="Implementing and decoding the revolutionary ULMFiT approach to train a language model on any downstream NLP task." />
<link rel="canonical" href="https://harish3110.github.io/through-tinted-lenses/natural%20language%20processing/sentiment%20analysis/2021/10/27/Introduction-to-NLP-using-Fastai.html" />
<meta property="og:url" content="https://harish3110.github.io/through-tinted-lenses/natural%20language%20processing/sentiment%20analysis/2021/10/27/Introduction-to-NLP-using-Fastai.html" />
<meta property="og:site_name" content="Through Tinted Lenses" />
<meta property="og:image" content="https://harish3110.github.io/through-tinted-lenses/images/ttl_small.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-27T00:00:00-05:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Harish Vadlamani"},"description":"Implementing and decoding the revolutionary ULMFiT approach to train a language model on any downstream NLP task.","headline":"Introduction to NLP using Fastai","dateModified":"2021-10-27T00:00:00-05:00","datePublished":"2021-10-27T00:00:00-05:00","@type":"BlogPosting","image":"https://harish3110.github.io/through-tinted-lenses/images/ttl_small.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://harish3110.github.io/through-tinted-lenses/natural%20language%20processing/sentiment%20analysis/2021/10/27/Introduction-to-NLP-using-Fastai.html"},"url":"https://harish3110.github.io/through-tinted-lenses/natural%20language%20processing/sentiment%20analysis/2021/10/27/Introduction-to-NLP-using-Fastai.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/through-tinted-lenses/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://harish3110.github.io/through-tinted-lenses/feed.xml" title="Through Tinted Lenses" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-171791478-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>




<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff"><link rel="shortcut icon" type="image/x-icon" href="/through-tinted-lenses/images/ttl_small.png"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Introduction to NLP using Fastai | Through Tinted Lenses</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Introduction to NLP using Fastai" />
<meta name="author" content="Harish Vadlamani" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Implementing and decoding the revolutionary ULMFiT approach to train a language model on any downstream NLP task." />
<meta property="og:description" content="Implementing and decoding the revolutionary ULMFiT approach to train a language model on any downstream NLP task." />
<link rel="canonical" href="https://harish3110.github.io/through-tinted-lenses/natural%20language%20processing/sentiment%20analysis/2021/10/27/Introduction-to-NLP-using-Fastai.html" />
<meta property="og:url" content="https://harish3110.github.io/through-tinted-lenses/natural%20language%20processing/sentiment%20analysis/2021/10/27/Introduction-to-NLP-using-Fastai.html" />
<meta property="og:site_name" content="Through Tinted Lenses" />
<meta property="og:image" content="https://harish3110.github.io/through-tinted-lenses/images/ttl_small.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-27T00:00:00-05:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Harish Vadlamani"},"description":"Implementing and decoding the revolutionary ULMFiT approach to train a language model on any downstream NLP task.","headline":"Introduction to NLP using Fastai","dateModified":"2021-10-27T00:00:00-05:00","datePublished":"2021-10-27T00:00:00-05:00","@type":"BlogPosting","image":"https://harish3110.github.io/through-tinted-lenses/images/ttl_small.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://harish3110.github.io/through-tinted-lenses/natural%20language%20processing/sentiment%20analysis/2021/10/27/Introduction-to-NLP-using-Fastai.html"},"url":"https://harish3110.github.io/through-tinted-lenses/natural%20language%20processing/sentiment%20analysis/2021/10/27/Introduction-to-NLP-using-Fastai.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://harish3110.github.io/through-tinted-lenses/feed.xml" title="Through Tinted Lenses" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-171791478-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>



<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/through-tinted-lenses/">Through Tinted Lenses</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/through-tinted-lenses/about/">About Me</a><a class="page-link" href="/through-tinted-lenses/search/">Search</a><a class="page-link" href="/through-tinted-lenses/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Introduction to NLP using Fastai</h1><p class="page-description">Implementing and decoding the revolutionary <a href='https://arxiv.org/abs/1801.06146'>ULMFiT</a> approach to train a language model on any downstream NLP task.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-10-27T00:00:00-05:00" itemprop="datePublished">
        Oct 27, 2021
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Harish Vadlamani</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      24 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/through-tinted-lenses/categories/#Natural Language Processing">Natural Language Processing</a>
        &nbsp;
      
        <a class="category-tags-link" href="/through-tinted-lenses/categories/#Sentiment Analysis">Sentiment Analysis</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/harish3110/through-tinted-lenses/tree/master/_notebooks/2021-10-27-Introduction to NLP using Fastai.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/through-tinted-lenses/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          <div class="px-2">
    <a href="https://colab.research.google.com/github/harish3110/through-tinted-lenses/blob/master/_notebooks/2021-10-27-Introduction to NLP using Fastai.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/through-tinted-lenses/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#Dataset-Download-and--basic-EDA">Dataset Download and  basic EDA </a></li>
<li class="toc-entry toc-h2"><a href="#The-ULMFiT-approach">The ULMFiT approach </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Step-1:-Training-a-general-corpus-language-model">Step 1: Training a general corpus language model </a></li>
<li class="toc-entry toc-h3"><a href="#Side-Note:-Text-Pre-processing">Side Note: Text Pre-processing </a>
<ul>
<li class="toc-entry toc-h5"><a href="#1.-Tokenization">1. Tokenization </a></li>
<li class="toc-entry toc-h5"><a href="#2.-Numericalization">2. Numericalization </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Step-2:-Fine-tuning-pretrained-LM-to-downstream-dataset">Step 2: Fine-tuning pretrained LM to downstream dataset </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Discriminative-Fine-tuning">Discriminative Fine-tuning </a></li>
<li class="toc-entry toc-h4"><a href="#Slanted-Triangular-Learning-Rates">Slanted Triangular Learning Rates </a></li>
<li class="toc-entry toc-h4"><a href="#Creating-a-dataloader">Creating a dataloader </a></li>
<li class="toc-entry toc-h4"><a href="#Fine-tuning-the-language-model">Fine-tuning the language model </a>
<ul>
<li class="toc-entry toc-h5"><a href="#Embedding-Layer">Embedding Layer </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Step-3:-Training-a-classifier-on-the-downstream-NLP-task">Step 3: Training a classifier on the downstream NLP task </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Gradual-Unfreezing">Gradual Unfreezing </a></li>
<li class="toc-entry toc-h4"><a href="#Backpropagation-Throught-Time-for-Text-Classification-(BPT3C)">Backpropagation Throught Time for Text Classification (BPT3C) </a></li>
<li class="toc-entry toc-h4"><a href="#Concat-Pooling">Concat Pooling </a></li>
<li class="toc-entry toc-h4"><a href="#Creating-the-classifier-dataloader">Creating the classifier dataloader </a></li>
<li class="toc-entry toc-h4"><a href="#Defining-the-learner">Defining the learner </a></li>
<li class="toc-entry toc-h4"><a href="#Training-the-classifier">Training the classifier </a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Creating-a-Kaggle-submission-file">Creating a Kaggle submission file </a></li>
<li class="toc-entry toc-h2"><a href="#Conclusion">Conclusion </a></li>
<li class="toc-entry toc-h2"><a href="#References">References </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-10-27-Introduction to NLP using Fastai.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In continuation to my previous posts <a href="https://harish3110.github.io/through-tinted-lenses/fastai/image%20classification/2020/03/29/Building-an-image-classifier-using-Fastai-V2.html">1</a>, <a href="https://harish3110.github.io/through-tinted-lenses/fastai/image%20classification/model%20fine-tuning/2020/04/10/Improving-baseline-model.html">2</a>, which delved into the domain of computer vision by building and fine-tuning an image classification model using Fastai, I would like to venture into the fascinating domain of Natural Language Processing using Fastai.</p>
<p>For this post we'll be working on the <a href="https://www.kaggle.com/c/nlp-getting-started/overview">Real or Not? NLP with Disaster Tweets</a> competition dataset on Kaggle to build a text classifier to distinguish between normal tweets and tweets sent out during a natural disaster using the <a href="https://arxiv.org/abs/1801.06146">ULMFiT</a> approach and decoding this revolutionary paper that changed the NLP schenario for the better in the recent years.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>nvidia-smi
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Sat Sep 17 15:33:14 2022       
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 460.32.03    Driver Version: 460.32.03    CUDA Version: 11.2     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  Tesla T4            Off  | 00000000:00:04.0 Off |                    0 |
| N/A   63C    P0    27W /  70W |   2342MiB / 15109MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
                                                                               
+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
+-----------------------------------------------------------------------------+
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse</span>

<span class="c1"># Installing and importing the necessary libraries </span>
<span class="o">!</span>pip install fastai --quiet
<span class="o">!</span>pip install kaggle --quiet

<span class="kn">from</span> <span class="nn">fastai.text.all</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">'ignore'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dataset-Download-and--basic-EDA">
<a class="anchor" href="#Dataset-Download-and--basic-EDA" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dataset Download and  basic EDA<a class="anchor-link" href="#Dataset-Download-and--basic-EDA"> </a>
</h2>
<blockquote>
<p>Using Kaggle API to download the competition dataset and view the data</p>
<p><strong>Fill in your username and key from Kaggle and run the below code</strong></p>
</blockquote>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>touch ~/.kaggle/kaggle.json

<span class="n">api_token</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"username"</span><span class="p">:</span><span class="s2">"xxxxxxxxxx"</span><span class="p">,</span><span class="s2">"key"</span><span class="p">:</span><span class="s2">"xxxxxxxxxx"</span><span class="p">}</span>

<span class="kn">import</span> <span class="nn">json</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/root/.kaggle/kaggle.json'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">api_token</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

<span class="o">!</span>chmod <span class="m">600</span> ~/.kaggle/kaggle.json
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Using the kaggle api to search the name of the competition dataset to download</span>
<span class="o">!</span>kaggle competitions list -s <span class="s1">'nlp'</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>ref                                                deadline             category            reward  teamCount  userHasEntered  
-------------------------------------------------  -------------------  ---------------  ---------  ---------  --------------  
nlp-getting-started                                2030-01-01 00:00:00  Getting Started  Knowledge        725            True  
feedback-prize-english-language-learning           2022-11-29 23:59:00  Featured           $55,000        716           False  
contradictory-my-dear-watson                       2030-07-01 23:59:00  Getting Started     Prizes         41           False  
jigsaw-toxic-severity-rating                       2022-02-07 23:59:00  Featured           $50,000       2301           False  
jigsaw-unintended-bias-in-toxicity-classification  2019-07-18 19:35:00  Featured           $65,000       3165           False  
us-patent-phrase-to-phrase-matching                2022-06-20 23:59:00  Featured           $25,000       1889            True  
google-quest-challenge                             2020-02-10 23:59:00  Featured           $25,000       1571            True  
feedback-prize-2021                                2022-03-15 23:59:00  Featured          $160,000       2058           False  
nbme-score-clinical-patient-notes                  2022-05-03 23:59:00  Featured           $50,000       1471           False  
feedback-prize-effectiveness                       2022-08-23 23:59:00  Featured           $55,000       1557           False  
gendered-pronoun-resolution                        2019-04-22 23:59:00  Research           $25,000        838           False  
AI4Code                                            2022-11-10 23:59:00  Featured          $150,000        917           False  
word2vec-nlp-tutorial                              2015-06-30 23:59:00  Getting Started  Knowledge        577           False  
trec-covid-information-retrieval                   2020-06-03 11:00:00  Research             Kudos         19           False  
data-science-for-good-city-of-los-angeles          2019-06-21 23:59:00  Analytics          $15,000          0           False  
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The competition dataset we would like to download is the 1st one titled <code>nlp-getting-started</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset_path</span> <span class="o">=</span> <span class="s1">'/content/'</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="s1">'nlp-getting-started'</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">cd</span> {dataset_path}

<span class="c1"># Creating a folder for the dataset</span>
<span class="o">!</span>mkdir <span class="o">{</span>dataset<span class="o">}</span>
<span class="o">%</span><span class="k">cd</span> {dataset}

<span class="c1"># Using the Kaggle API to download dataset</span>
<span class="o">!</span>kaggle competitions download -c <span class="o">{</span>dataset<span class="o">}</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>/content
/content/nlp-getting-started
Downloading nlp-getting-started.zip to /content/nlp-getting-started
  0% 0.00/593k [00:00&lt;?, ?B/s]
100% 593k/593k [00:00&lt;00:00, 143MB/s]
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Unzip the dataset and delete the respective zip file</span>

<span class="o">!</span>unzip <span class="o">{</span>dataset + <span class="s1">'.zip'</span><span class="o">}</span>
<span class="o">!</span>rm <span class="o">{</span>dataset + <span class="s1">'.zip'</span><span class="o">}</span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Archive:  nlp-getting-started.zip
  inflating: sample_submission.csv   
  inflating: test.csv                
  inflating: train.csv               
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">dataset_path</span><span class="si">}{</span><span class="n">dataset</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="n">Path</span><span class="o">.</span><span class="n">BASE_PATH</span> <span class="o">=</span> <span class="n">path</span>
<span class="n">path</span><span class="o">.</span><span class="n">ls</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#3) [Path('train.csv'),Path('sample_submission.csv'),Path('test.csv')]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'train.csv'</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'test.csv'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-9c7df3a5-aae0-4ef4-82e9-d73069130929">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>keyword</th>
      <th>location</th>
      <th>text</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Our Deeds are the Reason of this #earthquake May ALLAH Forgive us all</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Forest fire near La Ronge Sask. Canada</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>All residents asked to 'shelter in place' are being notified by officers. No other evacuation or shelter in place orders are expected</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>13,000 people receive #wildfires evacuation orders in California</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>7</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Just got sent this photo from Ruby #Alaska as smoke from #wildfires pours into a school</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-9c7df3a5-aae0-4ef4-82e9-d73069130929')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-9c7df3a5-aae0-4ef4-82e9-d73069130929 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-9c7df3a5-aae0-4ef4-82e9-d73069130929');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train</span><span class="p">[</span><span class="s1">'target'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0    4342
1    3271
Name: target, dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-b4c8f163-fc29-4ea9-a601-0313c91271bb">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>keyword</th>
      <th>location</th>
      <th>text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Just happened a terrible car crash</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Heard about #earthquake is different cities, stay safe everyone.</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>there is a forest fire at spot pond, geese are fleeing across the street, I cannot save them all</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Apocalypse lighting. #Spokane #wildfires</td>
    </tr>
    <tr>
      <th>4</th>
      <td>11</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Typhoon Soudelor kills 28 in China and Taiwan</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-b4c8f163-fc29-4ea9-a601-0313c91271bb')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-b4c8f163-fc29-4ea9-a601-0313c91271bb button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-b4c8f163-fc29-4ea9-a601-0313c91271bb');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>The training set has 7613 records.
The test set has 3263 records.
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="The-ULMFiT-approach">
<a class="anchor" href="#The-ULMFiT-approach" aria-hidden="true"><span class="octicon octicon-link"></span></a>The ULMFiT approach<a class="anchor-link" href="#The-ULMFiT-approach"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The Universal Language Model Fine-tuning (ULMFiT) is an inductive transfer learning approach developed by Jeremy Howard and Sebastian Ruder to all the tasks in the domain of natural language processing which sparked the usage of transfer learning in NLP tasks.</p>
<p><strong>The ULMFiT approach to training NLP models is heralded as the ImageNet moment in the domain of Natural Language Processing</strong></p>
<p>The model architecture used in the entire process of the ULMFiT approach is ubiquitous and is the well-known <strong>AWD-LSTM</strong> architecture.</p>
<p>The ULMFiT approach can be braodly explained in the 3 major steps as shown below:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://miro.medium.com/max/2000/1*9n9yv4EalUn76yP1Yffhfw.png" alt="" title="The ULMFiT Process"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-1:-Training-a-general-corpus-language-model">
<a class="anchor" href="#Step-1:-Training-a-general-corpus-language-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 1: Training a general corpus language model<a class="anchor-link" href="#Step-1:-Training-a-general-corpus-language-model"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A language model is first trained on a corpus of Wikipedia articles known as Wikitext-103 using a <strong>self-supervised approach</strong>, i.e. using the training labels in itself to train models, in this case training a LM to learn to predict the next word in a sequence. This resulting LM learns the semantics of the english language and captures general features in the different layers.</p>
<p>This pretrained language model is trained on 28,595 Wikipedia articles and training process is very expensive and time consuming and is luckily open-sourced in the Fastai library for us to use.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Side-Note:-Text-Pre-processing">
<a class="anchor" href="#Side-Note:-Text-Pre-processing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Side Note: Text Pre-processing<a class="anchor-link" href="#Side-Note:-Text-Pre-processing"> </a>
</h3>
<blockquote>
<p>Transforming and normalizing texts such that it can be trained on a neural network for language modeling</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In my previous post, <a href="https://harish3110.github.io/through-tinted-lenses/fastai/image%20classification/2020/03/29/Building-an-image-classifier-using-Fastai-V2.html#1.-Create-a-DataBlock:">Building an image classifier using Fastai V2</a> we look at the datablock API of Fastai and where we apply the <code>resize</code> transform that ensures that all images used for training the image classifier model are resized to the same dimensions in order to be able to collate them in the GPU.</p>
<p>The same type of pre-processing needs to be done for texts in order to train a language model. Whether it's the articles in the Wikipedia 103 dataset or tweets in disaster dataset are of different lengths and can be very long. Thus the tweets corpus i.e. the dataset needs to pre-processed correctly in order to train a neural network on text data.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There are many ways the pre-processing for textual data can be done and Fastai approach is to apply the following 2 main transforms to texts:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<p><strong><em>Note:</em></strong> A transform in Fastai is basically an <strong>almost</strong> reversible function that transforms data into another form(encoding) and also has the capability of getting back the original data(decoding) if needed.</p>
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="1.-Tokenization">
<a class="anchor" href="#1.-Tokenization" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Tokenization<a class="anchor-link" href="#1.-Tokenization"> </a>
</h5>
<p>The first step is to gather all the unique <code>tokens</code> in the corpus being used.</p>
<p>A <code>token</code> can be defined in numerous ways depedning on the person creating the language model based on the granularity level i.e. the smallest part of the text they would like to consider. In the simplest scenario, a word can be considered as the token.</p>
<p>So the idea is to get a list of all the unique words used in the general domain corpus(Wikipedia 103 dataset) and our added downstream dataset(Disaster tweets dataset) to build a vocabulary for training our language model.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Let's take an example text from our training set to show a tokenization example</span>

<span class="n">txt</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">txt</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'Our Deeds are the Reason of this #earthquake May ALLAH Forgive us all'</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Initializing the default tokenizer used in Fastai which is that of Spacy called `WordTokenizer`</span>
<span class="n">spacy</span> <span class="o">=</span> <span class="n">WordTokenizer</span><span class="p">()</span> 

<span class="c1"># Wrapping the Spacy tokenizer with a custom Fastai function to make some custom changes to the tokenizer</span>
<span class="n">tkn</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="p">(</span><span class="n">spacy</span><span class="p">)</span> 

<span class="n">tkn</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#21) ['xxbos','xxmaj','our','xxmaj','deeds','are','the','xxmaj','reason','of'...]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">txts</span> <span class="o">=</span> <span class="n">L</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">train</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]])</span>
<span class="n">txts</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#7613) ['Our Deeds are the Reason of this #earthquake May ALLAH Forgive us all','Forest fire near La Ronge Sask. Canada',"All residents asked to 'shelter in place' are being notified by officers. No other evacuation or shelter in place orders are expected",'13,000 people receive #wildfires evacuation orders in California ','Just got sent this photo from Ruby #Alaska as smoke from #wildfires pours into a school ','#RockyFire Update =&gt; California Hwy. 20 closed in both directions due to Lake County fire - #CAfire #wildfires','#flood #disaster Heavy rain causes flash flooding of streets in Manitou, Colorado Springs areas',"I'm on top of the hill and I can see a fire in the woods...","There's an emergency evacuation happening now in the building across the street","I'm afraid that the tornado is coming to our area..."...]</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Setting up a tokenizer on the entire dataframe 'train'</span>
<span class="n">tok</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">tok</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

<span class="n">toks</span> <span class="o">=</span> <span class="n">txts</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
<span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#21) ['xxbos','xxmaj','our','xxmaj','deeds','are','the','xxmaj','reason','of'...]</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<p><strong>Note:</strong> The special tokens you can see above starting with 'xx' are special fastai tokens added on top of the spacy tokenizer used to indicate certain extra meanings in the text data as follows:</p>
<ul>
<li>
<code>xxbos</code>:: Indicates the beginning of a text (here, a review)</li>
<li>
<code>xxmaj</code>:: Indicates the next word begins with a capital (since we lowercased everything)</li>
<li>
<code>xxunk</code>:: Indicates the next word is unknown</li>
</ul>
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As mentioned above <code>Tokenizer</code> is a Fastai transform, which is basically a function with and <code>encodes</code> and <code>decodes</code> method available to tokenize a text and return it back to <strong>almost</strong> the same initial state.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tok</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>'xxbos xxmaj our xxmaj deeds are the xxmaj reason of this # earthquake xxmaj may xxup allah xxmaj forgive us all'</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The reason we don't get the original string back when applying <code>decode</code> is because the default tokenizer used in this case isn't <code>reversible</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="2.-Numericalization">
<a class="anchor" href="#2.-Numericalization" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Numericalization<a class="anchor-link" href="#2.-Numericalization"> </a>
</h5>
<p>The next step in the pre-processing step is to index the tokens created earlier so that they can easily accessed.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">num</span> <span class="o">=</span> <span class="n">Numericalize</span><span class="p">()</span>
<span class="n">num</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span>
<span class="n">nums</span> <span class="o">=</span> <span class="n">toks</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">nums</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>TensorText([  2,   8, 150,   8,   0,  43,  14,   8, 885,  19])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">num</span><span class="o">.</span><span class="n">encodes</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>TensorText([   2,    8,  150,    8,    0,   43,   14,    8,  885,   19,   39,
              13,  301,    8,  170,    7, 1620,    8,    0,  120,   65])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">num</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">10</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#10) ['xxbos','xxmaj','our','xxmaj','xxunk','are','the','xxmaj','reason','of']</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-2:-Fine-tuning-pretrained-LM-to-downstream-dataset">
<a class="anchor" href="#Step-2:-Fine-tuning-pretrained-LM-to-downstream-dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 2: Fine-tuning pretrained LM to downstream dataset<a class="anchor-link" href="#Step-2:-Fine-tuning-pretrained-LM-to-downstream-dataset"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Despite having a vast language model pre-trained, it's always likely that the specific downstream task we would like to build our NLP model is a part of a slightly different distribution and thus  need to fine-tune this Wikitext 103 LM.</p>
<p>This step is much faster and it converges much faster as there will be an overlap to the general domain dataset. It only needs to adapt to the idiosyncrasies of the language used and not learn the language per say.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since NLP models are more shallow in comparison to a computer vision model, the fine-tuning approaches need to be different and thus the paper provides novel fine-tuning techniques to do so:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Discriminative-Fine-tuning">
<a class="anchor" href="#Discriminative-Fine-tuning" aria-hidden="true"><span class="octicon octicon-link"></span></a>Discriminative Fine-tuning<a class="anchor-link" href="#Discriminative-Fine-tuning"> </a>
</h4>
<p>Since different layers of the model capture different types of information and thus they should be fine-tuned to different extents.</p>
<p>This idea is similar as the use of discriminative learning rates used in CV applications which I explained in detail in my previous <a href="https://harish3110.github.io/through-tinted-lenses/image%20classification/2021/10/03/Improving-baseline-model.html#Discriminative-learning-rates">post</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Slanted-Triangular-Learning-Rates">
<a class="anchor" href="#Slanted-Triangular-Learning-Rates" aria-hidden="true"><span class="octicon octicon-link"></span></a>Slanted Triangular Learning Rates<a class="anchor-link" href="#Slanted-Triangular-Learning-Rates"> </a>
</h4>
<p>The idea behind slanted learning rates is that for a pretrained language model to adpat/fine-tune itself to the downstream dataset, the fine-tuning process should ideally converge faster to asuitable region in the parameter space and thern refine its parameters there.</p>
<p>So the slanted learning rates approach first linearly increases the learning rates for a short period and then linearly decays the learning rate slowly which is a modification of of Leslie Smith's traingular learning rate approache where the increase and decrease is almost the same.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://miro.medium.com/max/1096/1*QptmUluWXteT6oI5bD22rw.png" alt="" title="Slanted Triangular Learning Rates"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Creating-a-dataloader">
<a class="anchor" href="#Creating-a-dataloader" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating a dataloader<a class="anchor-link" href="#Creating-a-dataloader"> </a>
</h4>
<blockquote>
<p>Putting the pre-processed data in batches of text sequences for fine-tuning the language model</p>
</blockquote>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># dataset for fine-tuning language model which only needs the text data</span>

<span class="n">df_lm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[[</span><span class="s1">'text'</span><span class="p">]]</span>
<span class="n">df_lm</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-9bbe8e08-e998-4ecc-a08a-5fb60c961d37">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Our Deeds are the Reason of this #earthquake May ALLAH Forgive us all</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Forest fire near La Ronge Sask. Canada</td>
    </tr>
    <tr>
      <th>2</th>
      <td>All residents asked to 'shelter in place' are being notified by officers. No other evacuation or shelter in place orders are expected</td>
    </tr>
    <tr>
      <th>3</th>
      <td>13,000 people receive #wildfires evacuation orders in California</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Just got sent this photo from Ruby #Alaska as smoke from #wildfires pours into a school</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-9bbe8e08-e998-4ecc-a08a-5fb60c961d37')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-9bbe8e08-e998-4ecc-a08a-5fb60c961d37 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-9bbe8e08-e998-4ecc-a08a-5fb60c961d37');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<p><strong><em>Note:</em></strong> An important trick used in creating a dataloader here is that we use all the data available to us i.e train and test data. In case we had a dataset with unlabeled reviews we could also use that to fine-tune the pre-trained model better since this step doesn't need labels and is self-supervised.</p>
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Creating a dataloader for self-supervised learning task which tries to predict the next word in a sequence as represented by <code>text_</code> below.</p>
<p><strong>Fastai handles text processing steps like tokenization and numericalization internally when <code>TextBlock</code> is passed to <code>DataBlock</code>.</strong></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls_lm</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span>
    <span class="n">blocks</span><span class="o">=</span><span class="n">TextBlock</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="s1">'text'</span><span class="p">,</span> <span class="n">is_lm</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">get_x</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">'text'</span><span class="p">),</span> 
    <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> 
    <span class="c1"># using only 10% of entire comments data for validation inorder to learn more</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls_lm</span> <span class="o">=</span> <span class="n">dls_lm</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">df_lm</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="mi">72</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<p><strong><em>Note:</em></strong></p>
<ul>
<li>Select the batch size <code>bs</code> based on how much your GPU can handle without running out of memory</li>
<li>The sequence length <code>seq_len</code> for the data split used here is the default sequence length used for training the Wikipedia 103 language model</li>
</ul>
<hr>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls_lm</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>text_</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos xxup rt @livingsafely : xxup nws posts xxmaj severe # xxmaj thunderstorm xxmaj warnings for parts of # xxup ar # xxup nc # xxup ok . xxmaj seek strong shelter if at risk : http : / / t.co / xxunk xxbos xxmaj fire crews evacuate passengers from a xxmaj gold xxmaj coast tram trapped when powerlines fell across a xxunk . # xxunk 5 pm http : / /</td>
      <td>xxup rt @livingsafely : xxup nws posts xxmaj severe # xxmaj thunderstorm xxmaj warnings for parts of # xxup ar # xxup nc # xxup ok . xxmaj seek strong shelter if at risk : http : / / t.co / xxunk xxbos xxmaj fire crews evacuate passengers from a xxmaj gold xxmaj coast tram trapped when powerlines fell across a xxunk . # xxunk 5 pm http : / / t.co</td>
    </tr>
    <tr>
      <th>1</th>
      <td>entire group based on the actions of a few .. a heart - warming xxunk against terrorism .. http : / / t.co / xxunk xxbos xxunk nah young blood that cook is gone xxmaj i 'm cut now xxunk xxbos xxmaj greece 's tax revenues collapse as debt crisis continues http : / / t.co / xxunk xxbos xxmaj gas xxunk forces evacuation in east xxmaj saint xxmaj john http :</td>
      <td>group based on the actions of a few .. a heart - warming xxunk against terrorism .. http : / / t.co / xxunk xxbos xxunk nah young blood that cook is gone xxmaj i 'm cut now xxunk xxbos xxmaj greece 's tax revenues collapse as debt crisis continues http : / / t.co / xxunk xxbos xxmaj gas xxunk forces evacuation in east xxmaj saint xxmaj john http : /</td>
    </tr>
    <tr>
      <th>2</th>
      <td>xxunk xxmaj another shooting in a movie theater this is getting more xxunk but xxmaj i 'm glad they got the shooter &amp; &amp; no casualties . xxbos who xxunk all night in xxunk light of xxmaj xxunk floated out and sat through the xxunk beer afternoon in desolate xxmaj xxunk xxbos xxmaj xxunk xxmaj empire - xxmaj first responders turn out for xxmaj national xxmaj night xxmaj out http : /</td>
      <td>xxmaj another shooting in a movie theater this is getting more xxunk but xxmaj i 'm glad they got the shooter &amp; &amp; no casualties . xxbos who xxunk all night in xxunk light of xxmaj xxunk floated out and sat through the xxunk beer afternoon in desolate xxmaj xxunk xxbos xxmaj xxunk xxmaj empire - xxmaj first responders turn out for xxmaj national xxmaj night xxmaj out http : / /</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Saving the dataloader for fast use in the future</span>

<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dls_lm</span><span class="p">,</span> <span class="n">path</span><span class="o">/</span><span class="s1">'disaster_tweets_dls_lm.pkl'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># To load the Dataloaders in the future</span>

<span class="n">dls_lm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'disaster_tweets_dls_lm.pkl'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<h4 id="Fine-tuning-the-language-model">
<a class="anchor" href="#Fine-tuning-the-language-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fine-tuning the language model<a class="anchor-link" href="#Fine-tuning-the-language-model"> </a>
</h4>
<p>Fine-tuning Wikitext 103 based LM to disaster tweets using ULMFiT fine-tuning methodologies. This fine-tuned LM can thus be used as the base to classify disaster texts in the next step.</p>
<p>The common metric used in CV models is accuracy but in sequence based models we use something called <strong>perplexity</strong> which is basically exponential of the loss as follows:</p>

<pre><code>torch.exp(cross_entropy)</code></pre>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#fine-tuning wikitext LM to disaster tweets dataset</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">language_model_learner</span><span class="p">(</span>
    <span class="n">dls_lm</span><span class="p">,</span> <span class="n">AWD_LSTM</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">Perplexity</span><span class="p">()])</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">model</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SequentialRNN(
  (0): AWD_LSTM(
    (encoder): Embedding(5832, 400, padding_idx=1)
    (encoder_dp): EmbeddingDropout(
      (emb): Embedding(5832, 400, padding_idx=1)
    )
    (rnns): ModuleList(
      (0): WeightDropout(
        (module): LSTM(400, 1152, batch_first=True)
      )
      (1): WeightDropout(
        (module): LSTM(1152, 1152, batch_first=True)
      )
      (2): WeightDropout(
        (module): LSTM(1152, 400, batch_first=True)
      )
    )
    (input_dp): RNNDropout()
    (hidden_dps): ModuleList(
      (0): RNNDropout()
      (1): RNNDropout()
      (2): RNNDropout()
    )
  )
  (1): LinearDecoder(
    (decoder): Linear(in_features=400, out_features=5832, bias=True)
    (output_dp): RNNDropout()
  )
)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<h5 id="Embedding-Layer">
<a class="anchor" href="#Embedding-Layer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Embedding Layer<a class="anchor-link" href="#Embedding-Layer"> </a>
</h5>
<p>We can see that the above <code>AWD LSTM</code> architecture used in ULMFiT has a bunch of layers called <strong>embedding</strong> layers as the input here.</p>
<p>The pre-processed text and the batching of data using dataloaders is followed by passing this data into an embedding layer which can be considered as a small neural network by itself which is used to calculate token i.e. word dependencies in the dataset. These layers are trained along with the main neural network model and learns relationships between words in the dataset along the way.</p>
<p>An embedding layer is a computationally efficient method to represent tokens in a lesser dimension space, being less sparse and as a look-up table for all tokens in our dataset which captures relationships between the tokens.</p>
<p>It's a much more computationally efficient approach to the traditional <code>one-hot encoding</code> appraoch which can make these types of task really expensive and inefficient.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="https://www.fast.ai/images/kittenavalanche.png" alt="" title="In the above embediing layer learned, vectors for baby animal words are closer together, and an unrelated word like 'avalanche' is further away"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you would like to know more about word embedding check out this amazing <a href="https://www.youtube.com/watch?v=25nC0n9ERq4">video</a> by Rachael Thomas, co-founder of Fastai.</p>
<hr>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SuggestedLRs(valley=0.004365158267319202)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYIAAAELCAYAAADURYGZAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAADh0RVh0U29mdHdhcmUAbWF0cGxvdGxpYiB2ZXJzaW9uMy4yLjIsIGh0dHA6Ly9tYXRwbG90bGliLm9yZy+WH4yJAAAgAElEQVR4nO3deXxV1b3//9fnZCQjZCAJBGSeB4EIdUK9WHCsVkWrtlarRVp/2N6qrXb09tZvvR2tWnFqta1WS3GoVqXUOosigwwyTwHCkAmSnMzT5/fHOcEQQwiQffY+53yej0ceydl7n73fSTQf1lp7ryWqijHGmOjlczuAMcYYd1khMMaYKGeFwBhjopwVAmOMiXJWCIwxJspZITDGmCjnaCEQkd4islBENorIBhE5tcP+a0VkjYisFZElIjLRyTzGGGM+K9bh8/8OWKSqV4hIPJDUYf8O4CxVPSgi5wOPAtO6OmFWVpYOGjTIkbDGGBOpVqxYUaaq2Z3tc6wQiEg6MB24HkBVG4HG9seo6pJ2Lz8E8o923kGDBrF8+fKeC2qMMVFARHYeaZ+TXUODgVLgCRH5WEQeF5HkLo6/EXitsx0iMkdElovI8tLSUieyGmNM1HKyEMQCk4H5qjoJqAHu7OxAETmHQCH4Xmf7VfVRVS1Q1YLs7E5bNsYYY46Tk4WgCChS1aXB1wsJFIbDiMgE4HHgElUtdzCPMcaYTjg2RqCq+0Vkt4iMVNVNwAxgfftjRGQg8DzwFVXdfLzXampqoqioiPr6+hMLHcYSExPJz88nLi7O7SjGmDDj9F1D84Cng3cMbQduEJG5AKr6MPBjIBN4SEQAmlW14FgvUlRURGpqKoMGDSJ4nqiiqpSXl1NUVMTgwYPdjmOMCTOOFgJVXQV0/MP+cLv9NwE3neh16uvro7YIAIgImZmZ2EC6MeZ4RMyTxdFaBNpE+/dvTKR7fX0xW0v8jpw7YgpBOElJSQGgsLCQcePGuZzGGBMOvvn0Sp5buceRc0dnIVizAH47Du7uHfi8ZoHbiYwx5ogamltobGklJcGZ3vzoKwRrFsDLt0LlbkADn1++9YSKwZ133snvf//7Q6/vvvtufvaznzFjxgwmT57M+PHj+cc//tHlOVpaWrjjjjs45ZRTmDBhAo888ggA1113HS+++OKh46699tqjnssYE1mq65sBrBD0mP/8FJrqDt/WVBfYfpyuuuoqFiz4tJAsWLCAr371q7zwwgusXLmSN998k9tuu42u1of+wx/+QHp6OsuWLWPZsmU89thj7NixgxtvvJEnn3wSgMrKSpYsWcKFF1543FmNMeGnpqEFcK4QOH37qPdUFh3b9m6YNGkSJSUl7N27l9LSUvr06UNubi7//d//zTvvvIPP52PPnj0UFxeTm5vb6TkWL17MmjVrWLhwYSBOZSVbtmxh5syZfPOb36S0tJTnnnuOyy+/nNjY6Pu1GRPN/A1NAKQkWiHoGen5wW6hTrafgNmzZ7Nw4UL279/PVVddxdNPP01paSkrVqwgLi6OQYMGdfnAm6rywAMPMGvWrM/su+6663jqqad49tlneeKJJ04opzEm/FjXUE+b8WOI63X4trhege0n4KqrruLZZ59l4cKFzJ49m8rKSvr27UtcXBxvvvkmO3ceceI/AGbNmsX8+fNpagpU/s2bN1NTUwPA9ddfz3333QfAmDFjTiinMSb81DQ6Wwiir0Uw4crA5//8NNAdlJ4fKAJt24/T2LFj8fv99O/fn7y8PK699louvvhixo8fT0FBAaNGjery/TfddBOFhYVMnjwZVSU7O/vQIHFOTg6jR4/m0ksvPaGMxpjw5G9rETjUNSRdDWB6UUFBgXZcj2DDhg2MHj3apUTOq62tZfz48axcuZL09PQjHhfpPwdjotXTS3fygxc+Yen3Z5CTlnhc5xCRFUeawif6uobCzOuvv87o0aOZN29el0XAGBO5ahqsayiqnXvuuUcdXzDGRLbq+mZEICk+xpHzW4vAGGM8zt/QTEp8rGNzikVMIQi3sY6eFu3fvzGRrKah2bGBYoiQQpCYmEh5eXnU/jFsW48gMfH4BpGMMd5W3dDs2PgARMgYQX5+PkVFRVE9H3/bCmXGmMjjr28m2QpB1+Li4mxlLmNMxKppaCbVuoaMMSZ6Od01ZIXAGGM8rtrhriErBMYY43HWIjDGmCimqlTbGIExxkSvuqYWWhXrGjLGmGjl9FoEYIXAGGM8rTo44Zx1DRljTJRqKwTJ8VYIjDEmKlU7vCgNWCEwxhhPq3Z4LQKwQmCMMZ5mYwTGGBPlDo0RWIvAGGOiU9h3DYlIbxFZKCIbRWSDiJzaYb+IyP0islVE1ojIZCfzGGNMuKmubyYuRkiIde7PtdPTUP8OWKSqV4hIPJDUYf/5wPDgxzRgfvCzMcYYAi2C5ATnlqkEB1sEIpIOTAf+AKCqjapa0eGwS4A/a8CHQG8RyXMqkzHGhBunJ5wDZ7uGBgOlwBMi8rGIPC4iyR2O6Q/sbve6KLjtMCIyR0SWi8jyaF6FzBgTfarrw7sQxAKTgfmqOgmoAe48nhOp6qOqWqCqBdnZ2T2Z0RhjPC3cWwRFQJGqLg2+XkigMLS3BxjQ7nV+cJsxxhgCy1Q6+VQxOFgIVHU/sFtERgY3zQDWdzjsJeC64N1DnwMqVXWfU5mMMSbc+EPQInD6rqF5wNPBO4a2AzeIyFwAVX0YeBW4ANgK1AI3OJzHGGPCSijGCBw9u6quAgo6bH643X4FbnEygzHGhLOaMB8jMMYYcwJaWpWaxpbwHSPwmq0l1Tz4xhb89U1uRzHGmG6paXR+egmIokKwrbSaXy3eTGFZrdtRjDGmW2pCMM8QRFEhGJgRmN1i1wErBMaY8BCKRWkgigrBACsExpgw4w/BFNQQRYUgJSGWzOR4KwTGmLDR1iJItULQcwZkJLHbCoExJkwcGiOwrqGeMzAjyVoExpiwcahrKN4KQY8ZmJHEnoo6mlta3Y5ijDFHdahryFoEPWdgRhItrcq+ynq3oxhjzFHV2GBxz7M7h4wx4aS6oZmEWB9xMc7+qY6qQjAw0wqBMSZ8+BuaHe8WgigrBLlpicTFiBUCY0xYCMWEcxBlhSDGJ+T3sTuHjDHhobre+UVpIMoKAdizBMaY8OFvaHb81lGIwkIwMKOXtQiMMWGhxsYInDEwI4mK2iYq62w6amOMt4Vi4XqI0kIAWPeQMcbzquubHX+GAKKwEAywQmCMCRPVDTZY7IjOHioLLJ1sjDHe0djcSkNzq+Mzj0IUFoK0xDj6JMUdKgTNLa1cPn8Jc/68nPqmFpfTGWNMQKiml4AoLARw+Cykz60sYuWuChavL2buUyusGBhjPKE6RMtUQpQWgrZnCeoaW/jtv7cwaWBvfn7ZeN7aVGrFwBjjCW2FwG4fdcjAjCSKDtbxh/e2s7+qnrvOH83VUwdyb7AYXP3Yh/xj1R5qG5vdjmqMiVLVIewacv4KHjQwI4nmVuX+N7Zy7ui+TB2cAcCXpg4kIc7Hr/61mW89u4qk+BguHJ/HXReMJiM53uXUxphocmjheisEzmh7lqC5pZXvnjfqsH1fnJTPJRP7s6zwAC+u2sNzK/awZFs58788mQn5vd2Ia4yJQn7rGnLWSVnJAFwxJZ8ROamf2e/zCdOGZPLzyybw97mnBo6d/wHPfrQrpDmNMdHr0HrFCXGOXysqC0H/3r145CtT+OFFY4567MQBvXl53hlMG5LBnc+v5U9LCp0PaIyJeoe6hqxF4JxZY3NJS+xepc1IjufJG6Zyzshs7nl1A5v2+x1OZ4yJdv6GZkQgKS7G8WtFbSE4VjE+4ZezJ5KWGMutz3xst5gaYxxVXd9MSnwsPp84fi1HC4GIFIrIWhFZJSLLO9mfLiIvi8hqEVknIjc4medEZaUk8MvZE9lU7Ofe1za6HccYE8GqG5pC0i0Eoblr6BxVLTvCvluA9ap6sYhkA5tE5GlVbQxBruNyzsi+XH/aIJ5cUsio3FRmFwwgJgQV2xgTXUI1BTW4f/uoAqkiIkAKcADw/FNcd54/itVFFdz5/Foef28H8/5rGBdN6BfSgrCvso5nP9rNlhI/m4ur2XOwjozkePqmJZCblsiInFQmDkhnfP/eZKcmhCyXMaZn+EO0TCWAODnzpojsAA4S+IP/iKo+2mF/KvASMApIBa5S1Vc6Oc8cYA7AwIEDp+zcudOxzN3V0qq8unYfD76xlU3FfkbkpHDv5ROYPLCP49eurG3i0ofeZ2d5DSdlJjOsbwoD+iRRUddIcVU9+yrq2VFeQ9uvdmh2MjPH5jJzTA4T83uHpM/RGHNivvjQ+6QkxPKXG6f1yPlEZIWqFnS6z+FC0F9V94hIX+DfwDxVfafd/iuA04HvAEODx0xU1aojnbOgoECXL//McINrWluVRev287N/rmdfVT3XnzaI22eOPK7Hwkuq6vndf7bwzzX7OG9sLvNmDCO/T9JhxzS1tHL9Ex+xbMdBnv76NE4ZlNHpuWoamlm3t4rVuyt4Z0spH2wrp7lV6ZuawOfH5DBrbC6fG5JJXVMLxVX1lFQ1UN/UQmNLK00trQzISGJifu/jauVU1jaxqdjPgZoGymsaaW5RxuenM7ZfGgmxn94B0djcys7yGraWVLOlpBqAUbmpjM5LIy89kYq6JsqrG6mqb6JvagL9evciLqbnhrUq65qob2ohOyXBiqPxnM//5m2G9U1h/pen9Mj5uioEjrY7VHVP8HOJiLwATAXeaXfIDcC9GqhGW4MtiFHAR07m6kk+n3DB+DzOHJ7FLxZt4on3C3llzT5mjO7L6cOyOG1oVpfTU1Q3NFNYVsNrn+zjj+8V0tTSyvQR2bzw8R6e/7iIq6cO5MqCAYzOSyPGJ/z05fW8v7WcX82eeMQiAIH5SaYOzmDq4Ay+Pn0IlXVNvLmxhMXr9/PCx3t4eukufAKtXfw7IL1XHGcMz2J43xQqaps4WNtIU0srJw/ozbTBmYztl4ZPhKr6JsqqG3h/azn/WrefpTsO0NLJieNjfYzOTaW+qZUSfz0Ha49tuVCfQG5aIlmpCaT3iqNPUjyxPqG+uYX6plZifMKQrGSGZqfQv08vDtY2sr+ynlJ/A1X1TVQ3tFDT0ExxVT27D9RSFbxPOz7WR37vXuT1TiTG5zt0rfgYH4lxMSTG+eiTFE9OWiI5aYk0NLewancFH++qoLC8hj5J8WSlxJOdmsCgzGQGZyUzJDuF4X1T6NPhd9/SqlTWNREbI8TH+IiP8VkRMp0K5RiBYy0CEUkGfKrqD379b+Cnqrqo3THzgWJVvVtEcoCVBFoERxpc9lyLoKOPdhzg0Xe2s3R7+aH7gM8YlsUVU/KZNTaX2sYWXt9QzOJ1xawuqqDU33DovV+Y2I/bZo7gpMxk9lbU8cAbW/n78t00tyqpibGMyk1lWeFBbp4+hLsuGH3cGeubWnhvSxkrdx0MjiskkpOaQFJ8LPGxPmJ8wsb9Vby9qZS3N5dS4m8gNSGWjJR4VD9d1Cch1kdzqx72R39odjKzxuYybUgmWSnxZCYnoCird1ewYudB1u+rIiUhluzUBLJSEjgpM4lh2akM7ZuMKmwu9rNxv5/9lfVkBt+fkhhLcVU9RQdqKTpYR3lNIxV1TVTUBlobveIDf6wbmlrZWV5LY0vrYd9vfKyP9F5xpCTEkpwQQ1ZKAgP6JDEgoxe94mIoOljH7oO17K+sp1UD/ZiqSmNzK/VNgSJzoLaRxuZPz5scH8OE/N4M65tCVX0Tpf6GYIGpO+z6fVMTGJmbSmJcDIVlNew8UHvYeWJ8wueGZHDeuDxmjc2hb2ricf9eTWQZ/5N/cUVBPj+5eGyPnM+VriERGQK8EHwZC/xVVe8RkbkAqvqwiPQDngTyACHQOniqq/N6vRC0aW5pZc2eSt7cWMLzK/ewp6KOlIRYahubadXA082nDs1kcFbgX5Bj8tIYFJz6or2SqnqWbCtn6Y5ylu44wNh+6dx31ckhG5hWVZpalPjYT7tkSqrqWbrjAKt2V5AY5yMjOYHM5HjG9U9nWN+UkOQ6kuaWVooO1rG3oo6MlHhy0xJJ7xVH4H6E46eqVNQ2UeyvRxCG9U3p9HfQ0qrsOVjHtrJqthZXs6nYz6b9fuqbWhgU/F3npiXSqkpDcysHaxp5Y2MJ28tqEIHhfVMY2y/QjTblpD42phOlVJUh33+VeecM4zszR/bIOV0bI3BCuBSC9lpblQ+2l/PPNXvJTE5g1thcxvVPO+E/TiYyqCqbi6tZvG4/q3ZXsG5vFfur6oHAsyszRvXlnFHZTBrYh5w0azFEg5qGZsb+5F98/4JRzJk+tEfO6doYgQnw+YTTh2Vx+rAst6MYDxIRRuamMjL30wkQS/0NLNlWxusbSnh17T7+tnw3ADlpCZw8oDeXT85nxugce4YlQlWHcMI5sEJgjCdlpyZwycn9ueTk/jQ2t7J2TwWrd1eypqiCD7aX8691xQzI6MV1nxvENdMGhmTxEhM6/hBOOAdWCIzxvPhYH1NOymDKSYG7xJpbWvn3+mKeWFLIPa9u4JmPdvHQlyczKjfN5aSmpxxapjJEBd4mnTMmzMTG+Dh/fB4Lbj6Vv359Gv6GZi79/fssXFEUOGDNAvjtOLi7d+DzmgXuBjbHLJRTUIO1CIwJa6cNzeKVW8/gW8+s4va/r+bgB0/xtYO/JaYlMNhM5W54+dbA1xOudC+oOSbVDYFnbEL1HIG1CIwJc31TE3nqpmnc9vkRXFj22KdFoE1THfznp+6EM8fFH8L1isEKgTERIcYnzJsxnDzKOz+gsii0gcwJ+fSuISsExphjJOn5nW6vSsjpdNoP401tYwShuhvMCoExkWTGjyGu12GbGiSBH/ov46t//OiwKU2Md1U3NJMQ6zvsiX4nWSEwJpJMuBIuvh/SBwAC6QOI/+KDnP7Fb7Cs8AAX3P8uH2w7QveR8YzqhmZSQ3THENhdQ8ZEnglXHnaHkABXARPye3PL0yu59vEP+e55o7h5+hCb5sSjQjnzKFiLwJioMTovjZfnncH54/O497WN3LZgNfVNLW7HMp2oDuHqZGAtAmOiSnJCLA9ePYlROan8+t+b2VZWw6NfmWKT2XmM31oExhgniQRuNX34y1PYUuznsoeWUFhW43Ys0051fXPIJpyDbhYCEUkWEV/w6xEi8gURCV1KY0yPO29cLn+bcyq1jc3MfuQDNu4/4gqxJsRCPVjc3RbBO0CiiPQHFgNfIbCgjDEmjI3PT2fBzafiE7jqkQ9ZtbvC7UiGQCFITog5+oE9pLuFQFS1FrgMeEhVZwM9s36aMcZVw3NSWTj3NNJ7xfHlx5eybm+l25Ginie7hgARkVOBa4FXgttCV66MMY4akJHE327+HGmJsVz/xDJ2B9elNqHX0NxCY0urJ7uGvg3cBbygquuC6xG/6VwsY0yo5aX34k9fm0pjcyvX/fEjyqvtKWQ3VId4wjnoZiFQ1bdV9Quq+n/BQeMyVb3V4WzGmBAbnpPKH68vYG9FHV97chm1jc1uR4o6oZ5wDrp/19BfRSRNRJKBT4D1InKHs9GMMW6YclIGD14zmbV7KrltwWpabbK6kDpUCDzYNTRGVauAS4HXgMEE7hwyxkSgz4/J4fsXjOa1T/Zz3+ub3Y4TVdq6hkK1TCV0vxDEBZ8buBR4SVWbAPtngjER7MYzBnNlQT73v7GVl1fvdTtO1PByi+ARoBBIBt4RkZMAe/rEmAgmIvzvpeM4ZVAfbv/7atYW2W2loeDZMQJVvV9V+6vqBRqwEzjH4WzGGJclxMbw8JenkJkczy1/XUlVfZPbkSKeP8QL10P3B4vTReQ3IrI8+PFrAq0DY0yEy0xJ4IFrJrGnoo67nl+LqvUKO6mtRZDqwQfK/gj4gSuDH1XAE06FMsZ4y5STMrh95kheWbOPv360y+04Ea26vhmfQGJc6OYE7W7bY6iqXt7u9f+IyConAhljvOnm6UP4cHs5//PyeiYN6MOYfmluR4pIbYvShHLRoO6WnDoROaPthYicDtQ5E8kY40U+n/CbKyfSJymOec+spK7RFrVxgr++mdTE0E7u3N1CMBf4vYgUikgh8CBw89HeFDx+rYisEpHlRzjm7OD+dSLydreTG2NCLjMlgd9ceTLbSmu459X1bseJSNUNTSG9Ywi62TWkqquBiSKSFnxdJSLfBtZ04+3nqGpZZztEpDfwEHCequ4Skb7dzG2Mccnpw7KYM30Ij76znbNH9OXcMTluR4oo1Q2hXaYSjnGFMlWtCj5hDPCdHrj+NcDzqroreP6SHjinMcZht80cwZi8NL773BpKqurdjhNRqhtaQt4iOJFh6e6MZCiwWERWiMicTvaPAPqIyFvBY67r9EIic9puXS0tLT2ByMaYnpAQG8P9V59MbWMzt/3d5iPqSdX1Td5uEXTQnd/8Gao6GTgfuEVEpnfYHwtMAS4EZgE/EpERn7mQ6qOqWqCqBdnZ2ScQ2RjTU4b1TeXHF43l3S1lPPzONrfjRIzqhuaQzjMERxkjEBE/nf/BF6DX0U6uqnuCn0tE5AVgKoFlL9sUAeWqWgPUiMg7wETAZrkyJgxcPXUAS7aV8evFmzllUAanDMpwO1LYC6xO5qEWgaqmqmpaJx+pqnq0IpIsIqltXwMzCUxh3d4/gDNEJFZEkoBpwIbj/3aMMaEkIvz8svHk9+nFrc98zIGaRrcjhbWWVqWmsSWsuoaOJgd4T0RWAx8Br6jqIhGZKyJzAVR1A7CIwN1HHwGPq2rHYmGM8bDUxDh+f81kyqsbuW3BKhsvOAE1jaGfcA66/2TxMVPV7QS6eTpuf7jD618Cv3QqhzHGeeP6p/ODC0fzk5fWMf/tbdxyzjC3I4UlN5apBGdbBMaYKHLdqSdx8cR+/HrxJt7f2umjQ+Yo3FiLAKwQGGN6iIhw72XjGZKdwq3PfMy+SpuF5lj5rUVgjAl3yQmxPPzlKdQ3tXDL0ytpbG51O1JYOTQFtbUIjDHhbFjfFH5xxURW7qrgwTe2uB0nrHw6RuDNSeeMMabbLpyQx6Un92P+29vYUux3O07YqLExAmNMJPnhRWNITojlrufX2i2l3dS2FKiNERhjIkJWSgI/vHAMy3ce5JlltqpZd5TXNBIXI6RZi8AYEykun9yf04Zmcu+rGym2WUqPqtTfQGZyQkhXJwMrBMYYB4kI/++L42lsaeXe1za6HcfzyqobyE5NCPl1rRAYYxw1KCuZG04fzIur9rBpvw0cd6WsuoGslPiQX9cKgTHGcXPPGkJKfCy/+fcmt6N4Wqm/gawUaxEYYyJQ76R4bjpzCP9aV8zq3RVux/Gk1lalvLrRuoaMMZHrxjMHk5Ecz68WW6ugM5V1TTS3qrUIjDGRKyUhlm+cNZR3t5TxwbZyt+N4Tml1AwBZ1iIwxkSyr5x6EjlpCfzyXxtRtYfM2ivzBwpBtrUIjDGRLDEuhm+fO4KVuypY9Ml+t+N4SluLIDvV7hoyxkS42VPyGZGTwr2LNtrspO2UHmoRJIb82lYIjDEhFRvj464LRrOzvJanPtzpdhzPKKtuJD7GR1qv0E4vAVYIjDEuOHtENmcOz+L+N7ZQWdvkdhxPKPU3kJkSH/LpJcAKgTHGBSLCXeePprKuid+/tdXtOJ7g1vQSYIXAGOOSMf3SuGJyPk++X8juA7Vux3FdYHoJKwTGmCjznZkj8Png1/aQWXB6idDfMQRWCIwxLspL78WNZwzmxVV7WVtU6XYc17S2KuU17kwvAVYIjDEuu/msoWQkx/P/Xt0QtQ+ZVdQ10eLS9BJghcAY47K0xDhu/a9hfLC9nLc2l7odxxVtzxBYITDGRK1rpp3ESZlJ3PvqRlqicH3jskNPFVshMMZEqfhYH9+dNYpNxX5e+HiP23FCzloExhgDXDA+l3H907jv9c1RN/XEoRaBFQJjTDQTEW6fOZKig3X8bdkut+OEVGl1g2vTS4AVAmOMh5w1IptTBvXhgTe2UtfY4nackGl7hsCN6SXA4UIgIoUislZEVonI8i6OO0VEmkXkCifzGGO8TUS4Y9YoSvwN/PmDQrfjhEyZS0tUtglFi+AcVT1ZVQs62ykiMcD/AYtDkMUY43FTB2cwfUQ289/ehr8+OiakK3Np0fo2Xugamgc8B5S4HcQY4w23zxxBRW0Tj727w+0oIVHq4jxD4HwhUGCxiKwQkTkdd4pIf+CLwPyuTiIic0RkuYgsLy2NzgdOjIkmE/J7c8H4XB5/dzsl/nq34ziqpVU54OL0EuB8IThDVScD5wO3iMj0DvvvA76nql3eK6aqj6pqgaoWZGdnO5XVGOMhd8waRWNzK797fYvbURx1sLYxOL2EOxPOgcOFQFX3BD+XAC8AUzscUgA8KyKFwBXAQyJyqZOZjDHhYXBWMtdOG8izy3aztaTa7TiOaXuGICsSWwQikiwiqW1fAzOBT9ofo6qDVXWQqg4CFgLfVNUXncpkjAkv82YMp1dcDL9YtNHtKI4p8zcC7j1MBs62CHKA90RkNfAR8IqqLhKRuSIy18HrGmMiRFZKAnPPGsLi9cUsLzzgdhxHlFYHxkDcbBE49hibqm4HJnay/eEjHH+9U1mMMeHra2cM5s8f7OSeVzfw/DdOc+2hK6e0tQgi+a4hY4w5IUnxsdw2cwQf76rglbX73I7T48qqG4iP9ZGW6M70EmCFwBgTBq6YMoBRuan836KNNDRH1tQTpf4GslMSXG3pWCEwxnhejE/4wYWj2X2gjj8tKXQ7To8qLK+hf+9ermawQmCMCQtnDs/m7JHZPPDGVg7UNLodp0e0tCob9vkZ0y/N1RxWCIwxYeP7F4ympqGZ+/8TGQ+Z7Siroa6phbFWCIwxpntG5KTypakDeerDnWwrDf+HzNbtrQRgbL90V3NYITDGhJX/PncECbE+/u+18H/IbP3eKuJjfAzPSXE1hxUCY0xYyU5N4BtnD2Xx+mKWbi93O84JWbe3ihG5KcTFuPun2AqBMSbs3HjGEPLSE7nn1Q20tqrbcY6LqvLJ3krGudwtBFYIjDFhqFd8DLfPHMmaokpeXrPX7TjHZW9lPRW1Ta4PFH3wC0MAAA1lSURBVIMVAmNMmPripP6M7ZfGLxZtor4p/B4yW7cnMFA8xloExhhzfHw+4YcXjmFPRR3z39rmdpxjtm5vFSIwOi/V7ShWCIwx4evUoZlccnI/5r+1je1hdjvpur1VDMlKJinevTmG2lghMMaEtR9cOJqEOB8/+scnqIbPwPH6vZWuPz/QxgqBMSas9U1N5LvnjeL9reW8tDo8Bo4P1DSyt7LeEwPFYIXAGBMBrpk6kIkDevO//1xPZW2T23GOyitPFLexQmCMCXsxPuGeS8dxoKaRexdtcDvOUa3bWwVgLQJjjOlJ4/qnc+MZg3nmo9186PEnjtftraJ/7170SY53OwpghcAYE0G+8/mRDMxI4q7n13r62YJ1eytdn3q6PSsExpiI0Ss+hp9fNp4dZTX8zqNTVZf469leWsOkgb3djnKIFQJjTEQ5fVgWs6fk8+g72w8NynrJ+1vLAJg+PNvlJJ+yQmCMiTg/vHAMfZLiufO5tbR4bFK6dzeXkZEcz5g86xoyxhjHpCfF8ZOLx7B2TyV//qDQ7TiHqCrvbi3jtKGZ+HzuLVbfkRUCY0xEumhCHtNHZPPrxZvZX1nvdhwANhX7KfU3eKpbCKwQGGMilIjws0vG0dTSyv+8vM7tOAC8tyUwPnDG8CyXkxzOCoExJmINzEzi1hnDee2T/fxnQ7HbcXh3SxlDs5Pp17uX21EOY4XAGBPRvn7mEEbkpPCjFz/hQE2jaznqm1pYuqOcMz3WLQRWCIwxES4+1sevZk+krKaRbzy1gqaWVldyrNx5kPqmVs70WLcQWCEwxkSBCfm9+cXlE1i644Br4wXvbi0j1idMG5LpyvW74v6KCMYYEwKXTurPhn1VPPLOdkblpvHlz50U0uu/u6WUyQP7kJLgvT+7jrYIRKRQRNaKyCoRWd7J/mtFZE3wmCUiMtHJPMaY6Pbd80Zx9shs7n5p3aE7eEKhxF/Pur1VnuwWgtB0DZ2jqierakEn+3YAZ6nqeOB/gUdDkMcYE6VifML9V09iaHYKc59aEbIpKB55ezsCXDghLyTXO1aujhGo6hJVPRh8+SGQ72YeY0zkS0uM48mvnUJqYiw3PLGMooO1jl5vX2Udf/lwJ5dNzmdIdoqj1zpeThcCBRaLyAoRmXOUY28EXutsh4jMEZHlIrK8tLS0x0MaY6JLXnovnrxhKnVNLVz/xDIqap27rfSBN7aiqnxrxnDHrnGinC4EZ6jqZOB84BYRmd7ZQSJyDoFC8L3O9qvqo6paoKoF2dneuwfXGBN+Ruam8th1Bewqr2XOX1bQ0Nzz6xfsKq9lwbLdfOmUgQzISOrx8/cURwuBqu4Jfi4BXgCmdjxGRCYAjwOXqKq3lxUyxkSUzw3J5JezJ/DRjgPc+dxaVHt2ptL7Xt9MjE/4//5rWI+et6c5VghEJFlEUtu+BmYCn3Q4ZiDwPPAVVd3sVBZjjDmSS07uz+0zR/DCx3v47es9t5jN5mI/L6zaw1dPG0ROWmKPndcJTt7QmgO8ICJt1/mrqi4SkbkAqvow8GMgE3goeFzzEe4uMsYYx9xyzjB2Hajl/v9sIS89kaunDjyh89U1tnDrMx+T3iuOuWcN7aGUznGsEKjqduAzzwUEC0Db1zcBNzmVwRhjukNEuOeL49lf1cBdz6+lqq6JOdOHEPwH6jH78T8+YVOxnyeuP4UMjyxQ3xWbYsIYY4C4GB+PXTeFiybk8fPXNvKzVzbQehyrmy1Ytpu/ryhi3jnDOHtkXweS9jzvPetsjDEuSYiN4f4vTSIrJYE/vLeDfZV1/PSScWSlJHTr/ev2VvKjf3zC6cMy+da5IxxO23OsRWCMMe34fMJPLh7DXeePYvG6Yv7rV2/xlw93HnXt4/e3lnHNY0vpnRTH7740iRgPLUV5NFYIjDGmAxHh5rOGsujbZzKufzo/evETLn7gPf7y4U7KqhsOO1ZV+fMHhVz3x4/ITUtk4dzTut2C8Arp6ftmnVZQUKDLl39m/jpjjHGEqvLPNfu47/XNbCutIcYnTBucQVZKAi2tysHaRpZsK+fc0X2570uTPDm7KICIrDjSXZneTGyMMR4hIlw8sR8XTchj434//1yzl/9sKGFvRR0xPiHW5+NbM4bzrRnD8YVRd1B7VgiMMaYbRITReWmMzkvjjlmj3I7To2yMwBhjopwVAmOMiXJWCIwxJspZITDGmChnhcAYY6KcFQJjjIlyVgiMMSbKWSEwxpgoF3ZTTIhIKbAz+DIdqOzi647b4oCyY7xk+3N0Z1/Hbd3N2PY56xgzhipf2zb7GXorXzhk9Hq+E8nY1Tav/QxPUtXOF31X1bD9AB7t6uuO24DlJ3KN7uzruK27Gdt9PqaMocpnP0Nv5guHjF7PdyIZj5LVUz/Drj7CvWvo5aN8faT9x3uN7uzruK27Gb2e72jX6or9DI9+na4c7X1ez+j1fEfa352MR9t2LJz+GR5R2HUNnQgRWa4eXxPZ6xm9ng+8n9Hr+cD7Gb2eD8IjY5twbxEcq0fdDtANXs/o9Xzg/Yxezwfez+j1fBAeGYEoaxEYY4z5rGhrERhjjOnACoExxkQ5KwTGGBPlrBAYY0yUs0IQJCJnisjDIvK4iCxxO09nRMQnIveIyAMi8lW383QkImeLyLvBn+PZbufpjIgki8hyEbnI7SydEZHRwZ/fQhH5htt5OiMil4rIYyLyNxGZ6XaejkRkiIj8QUQWup2lTfC/uz8Ff27Xup2no4goBCLyRxEpEZFPOmw/T0Q2ichWEbmzq3Oo6ruqOhf4J/AnL2YELgHygSagyIP5FKgGEj2aD+B7wIKezNaTGVV1Q/C/wyuB0z2a8UVV/TowF7jKg/m2q+qNPZmrM8eY9TJgYfDn9gWnsx2zY3kE2qsfwHRgMvBJu20xwDZgCBAPrAbGAOMJ/LFv/9G33fsWAKlezAjcCdwcfO9CD+bzBd+XAzztwXyfB74EXA9c5MXfcfA9XwBeA67xasbg+34NTPZwvh79f+QEs94FnBw85q9O5jqej1gigKq+IyKDOmyeCmxV1e0AIvIscImq/hzotFtARAYClarq92JGESkCGoMvW7yWr52DQILX8gW7q5IJ/I9ZJyKvqmqrlzIGz/MS8JKIvAL8tafy9VRGERHgXuA1VV3ptXyhcixZCbSQ84FVeLAnJiIKwRH0B3a3e10ETDvKe24EnnAs0Wcda8bngQdE5EzgHSeDBR1TPhG5DJgF9AYedDYacIz5VPUHACJyPVDWk0WgC8f6MzybQDdCAvCqo8k+daz/Hc4DzgXSRWSYqj7sZDiO/WeYCdwDTBKRu4IFI1SOlPV+4EERuZDjn4vIMZFcCI6Zqv7E7QxdUdVaAsXKk1T1eQLFytNU9Um3MxyJqr4FvOVyjC6p6v0E/rB5kqqWExi/8AxVrQFucDvHkXiuidKD9gAD2r3OD27zEq9ntHwnzjKeOK/nay+csh4SyYVgGTBcRAaLSDyBQcKXXM7UkdczWr4TZxlPnNfztRdOWT/l9mh1D43ePwPs49PbKm8Mbr8A2ExgFP8HltHyWUZvZ/R6vnDNerQPm33UGGOiXCR3DRljjOkGKwTGGBPlrBAYY0yUs0JgjDFRzgqBMcZEOSsExhgT5awQmIggItUhvl6PrFkhgTUcKkVklYhsFJFfdeM9l4rImJ64vjFghcCYTolIl/NwqeppPXi5d1X1ZGAScJGIHG0dgksJzKBqTI+wQmAilogMFZFFIrJCAiunjQpuv1hElorIxyLyuojkBLffLSJ/EZH3gb8EX/9RRN4Ske0icmu7c1cHP58d3L8w+C/6p4PTNCMiFwS3rRCR+0Xkn13lVdU6AtMU9w++/+siskxEVovIcyKSJCKnEViv4JfBVsTQI32fxnSXFQITyR4F5qnqFOB24KHg9veAz6nqJOBZ4Lvt3jMGOFdVrw6+HkVgau2pwE9EJK6T60wCvh187xDgdBFJBB4Bzg9eP/toYUWkDzCcT6cYf15VT1HVicAGAlMYLCEwd80dqnqyqm7r4vs0pltsGmoTkUQkBTgN+HvwH+jw6WI5+cDfRCSPwCpSO9q99aXgv8zbvKKqDUCDiJQQWH2t4zKcH6lqUfC6q4BBBJbs3K6qbed+BphzhLhnishqAkXgPlXdH9w+TkR+RmB9hxTgX8f4fRrTLVYITKTyARXBvveOHgB+o6ovBReCubvdvpoOxza0+7qFzv+f6c4xXXlXVS8SkcHAhyKyQFVXAU8Cl6rq6uBiOmd38t6uvk9jusW6hkxEUtUqYIeIzIbA8ooiMjG4O51P54j/qkMRNgFD2i1leNRF3oOth3uB7wU3pQL7gt1R17Y71B/cd7Tv05husUJgIkWSiBS1+/gOgT+eNwa7XdYRWDsWAi2Av4vICqDMiTDB7qVvAouC1/EDld1468PA9GAB+RGwFHgf2NjumGeBO4KD3UM58vdpTLfYNNTGOEREUlS1OngX0e+BLar6W7dzGdORtQiMcc7Xg4PH6wh0Rz3ich5jOmUtAmOMiXLWIjDGmChnhcAYY6KcFQJjjIlyVgiMMSbKWSEwxpgo9/8DPoNW73LnCMkAAAAASUVORK5CYII=%0A">
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's train the last layer of the model using a learning rate of <code>1e-2</code> based on the above learning rate finder plot using Leslie Smith's <a href="https://arxiv.org/abs/1708.07120">1 Cycle Training</a> approach.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fine_tune</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>perplexity</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>4.834417</td>
      <td>3.721524</td>
      <td>0.385059</td>
      <td>41.327328</td>
      <td>00:14</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>perplexity</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>3.752483</td>
      <td>3.395519</td>
      <td>0.419342</td>
      <td>29.830124</td>
      <td>00:15</td>
    </tr>
    <tr>
      <td>1</td>
      <td>3.487922</td>
      <td>3.161577</td>
      <td>0.450106</td>
      <td>23.607807</td>
      <td>00:14</td>
    </tr>
    <tr>
      <td>2</td>
      <td>3.245892</td>
      <td>3.043963</td>
      <td>0.466685</td>
      <td>20.988258</td>
      <td>00:15</td>
    </tr>
    <tr>
      <td>3</td>
      <td>3.077577</td>
      <td>3.003706</td>
      <td>0.471719</td>
      <td>20.160116</td>
      <td>00:15</td>
    </tr>
    <tr>
      <td>4</td>
      <td>2.952500</td>
      <td>2.996089</td>
      <td>0.473472</td>
      <td>20.007145</td>
      <td>00:15</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once we have fine-tuned out LM to our downstream task, we save the <code>encoder</code> part of the model which portion of the model except the final layer that predicts the next word in the sequence.</p>
<p>We can then use this<code>encoder</code> part, which is the portion that learns the language semantics, as our base to build a disaster tweets classification model.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Saving the encoder</span>

<span class="n">learn</span><span class="o">.</span><span class="n">save_encoder</span><span class="p">(</span><span class="s1">'finetuned'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-3:-Training-a-classifier-on-the-downstream-NLP-task">
<a class="anchor" href="#Step-3:-Training-a-classifier-on-the-downstream-NLP-task" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 3: Training a classifier on the downstream NLP task<a class="anchor-link" href="#Step-3:-Training-a-classifier-on-the-downstream-NLP-task"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have a language model fine-tuned to our downstream NLP dataset we can use the encoder portion of the fine-tuned language model which is the part that learns the features of the language used in the downstream dataset as the base to build a text classifier for tasks such as sentiment analysis, spam detection, fraud detection, document classifcation etc.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The encoder saved is then appended by a simple classifier consisting of two additional linear blocks consisting of the  standard batch normalization and dropout, with ReLU activations for the intermediate layer and a softmax activation at the last layer for the classification purpose.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Fine-tuning a classifier is a very critical task in a transfer learning method and is the main reason why transfer learning approaches failed until ULMFiT came along.</p>
<p>Overly aggressive fine-tuning can result in <strong>catastrophic forgetting</strong> and too cautious fine-tuning can lead to extremely slow convergence.</p>
<p>To tackle this problem, ULMFiT introduces a novel fine-tuning technique in <strong>gradual unfreezing</strong> besides also using <strong>slanted triangular learning rates</strong> and <strong>discriminative fine-tuning</strong> to successfully train a classifier using a pre-trained LM.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Gradual-Unfreezing">
<a class="anchor" href="#Gradual-Unfreezing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Gradual Unfreezing<a class="anchor-link" href="#Gradual-Unfreezing"> </a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The idea behind gradual unfreezing is that fine-tuning a classifier on all layers can result in catastrophic forgetting and thus each layer staring form the las layer is trained one after the other by freezing all the lower layers and only training the layer in question.</p>
<p>The paper empirically found that after training the last layer of the model with a learning rate of <code>lr</code>, the subsequent layers can be trained one after another by reducing <code>lr</code> by a factor of <code>2.6</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Backpropagation-Throught-Time-for-Text-Classification-(BPT3C)">
<a class="anchor" href="#Backpropagation-Throught-Time-for-Text-Classification-(BPT3C)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Backpropagation Throught Time for Text Classification (BPT3C)<a class="anchor-link" href="#Backpropagation-Throught-Time-for-Text-Classification-(BPT3C)"> </a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since the model architecture for training and fine-tuning the language is that of an LSTM, the paper implements the backpropagation through time(BPTT) approach to be able propagate gradients without them exploding or vanishing.</p>
<p>In the ULMFiT approach, a modification to the traditional BPTT is made specifically in the fine-tuning classifier phase called <strong>BPTT for Text Classification(BPT3C)</strong> to make fine-tuning a classifier for large documents feasible.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Steps in BPT3C:</p>
<ul>
<li>The document is divided into fixed length batches of size 'b'. </li>
<li>At the beginning of each batch, the model is initiated with the final state of the previous batch by keeping track of the hidden states for mean and max-pooling. </li>
<li>The gradients are back-propagated to the batches whose hidden states contributed to the final prediction. </li>
<li>In practice, variable length back-propagation sequences are used. </li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Concat-Pooling">
<a class="anchor" href="#Concat-Pooling" aria-hidden="true"><span class="octicon octicon-link"></span></a>Concat Pooling<a class="anchor-link" href="#Concat-Pooling"> </a>
</h4>
<p>Since signals for classifying texts can exist anywhere and are not only limited to last word in the sequence, the ULMFiT approach also proposes to concatenate the last time step of the document by max-pooling and mean-pooling representations to provide more signal and better training</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Creating-the-classifier-dataloader">
<a class="anchor" href="#Creating-the-classifier-dataloader" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating the classifier dataloader<a class="anchor-link" href="#Creating-the-classifier-dataloader"> </a>
</h4>
<p>Ensure that the sequence length and vocab passed to the <code>TextBlock</code> is same as that given while fine-tuning LM</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">TextBlock</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="s1">'text'</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="n">dls_lm</span><span class="o">.</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">vocab</span><span class="o">=</span><span class="n">dls_lm</span><span class="o">.</span><span class="n">vocab</span><span class="p">),</span> <span class="n">CategoryBlock</span><span class="p">())</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span>
                <span class="n">get_x</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">'text'</span><span class="p">),</span>
                <span class="n">get_y</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">'target'</span><span class="p">),</span>
                <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>category</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos _ \n▁ xxrep 5 ? xxup retweet \n▁ xxrep 7 ? \n▁ xxrep 5 ? xxup follow xxup all xxup who xxup rt \n▁ xxrep 7 ? \n▁ xxrep 5 ? xxup xxunk \n▁ xxrep 7 ? \n▁ xxrep 5 ? xxup gain xxup with \n▁ xxrep 7 ? \n▁ xxrep 5 ? xxup follow ? xxunk # xxup xxunk \n▁ # xxup ty</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>xxbos . : . : . : . : . : . : . : . : . : . : . : . : . : . : . : . : . : . : . : . : . : xxup rt xxunk : # xxunk \n\n xxmaj indian xxmaj army xxunk _ http : / / t.co / xxunk g</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>xxbos i xxmaj hate xxmaj to xxmaj talking xxmaj xxunk xxmaj with xxmaj my xxmaj grandma … i xxmaj mean i xxmaj love xxmaj her xxmaj as xxmaj to xxmaj death xxmaj but xxmaj she xxmaj talk xxmaj so xxmaj damn xxmaj much xxmaj xxunk xxrep 3 h xxrep 3 e xxunk xxrep 3 ! xxrep 6 ?</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">train_ds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">valid_ds</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(6091, 1522)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Saving the dataloader for fast use in the future</span>

<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dls_lm</span><span class="p">,</span> <span class="n">path</span><span class="o">/</span><span class="s1">'disaster_tweets_dls_cls.pkl'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Defining-the-learner">
<a class="anchor" href="#Defining-the-learner" aria-hidden="true"><span class="octicon octicon-link"></span></a>Defining the learner<a class="anchor-link" href="#Defining-the-learner"> </a>
</h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">text_classifier_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">AWD_LSTM</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">FBeta</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">learn</span><span class="o">.</span><span class="n">load_encoder</span><span class="p">(</span><span class="s1">'finetuned'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;fastai.text.learner.TextLearner at 0x7f822e1ff610&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse</span>
<span class="n">learn</span><span class="o">.</span><span class="n">model</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SequentialRNN(
  (0): SentenceEncoder(
    (module): AWD_LSTM(
      (encoder): Embedding(5832, 400, padding_idx=1)
      (encoder_dp): EmbeddingDropout(
        (emb): Embedding(5832, 400, padding_idx=1)
      )
      (rnns): ModuleList(
        (0): WeightDropout(
          (module): LSTM(400, 1152, batch_first=True)
        )
        (1): WeightDropout(
          (module): LSTM(1152, 1152, batch_first=True)
        )
        (2): WeightDropout(
          (module): LSTM(1152, 400, batch_first=True)
        )
      )
      (input_dp): RNNDropout()
      (hidden_dps): ModuleList(
        (0): RNNDropout()
        (1): RNNDropout()
        (2): RNNDropout()
      )
    )
  )
  (1): PoolingLinearClassifier(
    (layers): Sequential(
      (0): LinBnDrop(
        (0): BatchNorm1d(1200, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (1): Dropout(p=0.2, inplace=False)
        (2): Linear(in_features=1200, out_features=50, bias=False)
        (3): ReLU(inplace=True)
      )
      (1): LinBnDrop(
        (0): BatchNorm1d(50, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (1): Dropout(p=0.1, inplace=False)
        (2): Linear(in_features=50, out_features=2, bias=False)
      )
    )
  )
)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<h4 id="Training-the-classifier">
<a class="anchor" href="#Training-the-classifier" aria-hidden="true"><span class="octicon octicon-link"></span></a>Training the classifier<a class="anchor-link" href="#Training-the-classifier"> </a>
</h4>
<blockquote>
<p>Fine-tuning a text classifier using gradual unfreezing, slanted learning rates and discriminating learning techniques.</p>
</blockquote>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>fbeta_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.535416</td>
      <td>0.458821</td>
      <td>0.779238</td>
      <td>0.712329</td>
      <td>00:09</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Applying gradual unfreezing of one layer after another</span>

<span class="n">learn</span><span class="o">.</span><span class="n">freeze_to</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">1e-3</span><span class="o">/</span><span class="p">(</span><span class="mf">2.6</span><span class="o">**</span><span class="mi">4</span><span class="p">),</span><span class="mf">1e-2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>fbeta_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.501659</td>
      <td>0.448380</td>
      <td>0.787122</td>
      <td>0.728188</td>
      <td>00:10</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">freeze_to</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">5e-3</span><span class="o">/</span><span class="p">(</span><span class="mf">2.6</span><span class="o">**</span><span class="mi">4</span><span class="p">),</span><span class="mf">1e-2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>fbeta_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.485733</td>
      <td>0.428565</td>
      <td>0.812089</td>
      <td>0.780338</td>
      <td>00:10</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">1e-3</span><span class="o">/</span><span class="p">(</span><span class="mf">2.6</span><span class="o">**</span><span class="mi">4</span><span class="p">),</span><span class="mf">3e-3</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>fbeta_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.431396</td>
      <td>0.422173</td>
      <td>0.813403</td>
      <td>0.765677</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.401168</td>
      <td>0.432388</td>
      <td>0.815374</td>
      <td>0.778914</td>
      <td>00:11</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">'final_model'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Path('models/final_model.pth')</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Creating-a-Kaggle-submission-file">
<a class="anchor" href="#Creating-a-Kaggle-submission-file" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating a Kaggle submission file<a class="anchor-link" href="#Creating-a-Kaggle-submission-file"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sub</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'sample_submission.csv'</span><span class="p">)</span>
<span class="n">sub</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-3c837119-db78-44b5-89bb-236abedd524a">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>11</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-3c837119-db78-44b5-89bb-236abedd524a')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-3c837119-db78-44b5-89bb-236abedd524a button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-3c837119-db78-44b5-89bb-236abedd524a');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dl</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">test_dl</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s1">'text'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preds</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">dl</span><span class="o">=</span><span class="n">dl</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Let's view the output of a single row of data</span>

<span class="n">preds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([0.12764977, 0.8723502 ], dtype=float32)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Since it's a multi-class problem and it uses softmax on the binary classes, </span>
<span class="c1"># Need to calculate argmax of the output to get the best class as follows </span>

<span class="n">preds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor(1)</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sub</span><span class="p">[</span><span class="s1">'target'</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sub</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">

  <div id="df-b6f9a191-875c-415b-8e39-404d194846ac">
    <div class="colab-df-container">
      <div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>11</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-b6f9a191-875c-415b-8e39-404d194846ac')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  &lt;svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px"&gt;
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  &lt;/svg&gt;
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-b6f9a191-875c-415b-8e39-404d194846ac button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-b6f9a191-875c-415b-8e39-404d194846ac');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sub</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">'submission.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>kaggle competitions submit -c nlp-getting-started -f submission.csv -m <span class="s2">"ULMFiT Submission 1"</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>100% 22.2k/22.2k [00:01&lt;00:00, 17.5kB/s]
Successfully submitted to Natural Language Processing with Disaster Tweets</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To view the results from your submission, run the following code:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>kaggle competitions submissions -c nlp-getting-started
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>fileName                             date                 description                                                            status    publicScore  privateScore  
-----------------------------------  -------------------  ---------------------------------------------------------------------  --------  -----------  ------------  
submission.csv                       2022-09-17 16:03:11  ULMFiT Submission 1                                                    complete  0.81091                    
submission_hf_trainer.csv            2021-07-13 06:20:09  Using trainer api basic                                                complete  0.82653                    
submission_hf_fp16.csv               2021-06-21 19:37:14  Bert Base Uncased using FP16 training                                  complete  0.83052                    
submission_transformers_pytorch.csv  2021-06-21 12:51:41  Using bert-base-uncased via hugging face but using native pytorch      complete  0.82500                    
submission_transformers.csv          2021-06-21 12:07:17  HuggingFace Bert Uncased Submission 1                                  complete  0.82684                    
submission.csv                       2021-06-21 07:00:15  ULMFiT Submission 1                                                    complete  0.81458                    
submission_ensemble.csv              2020-06-30 11:13:05  Roberta and LR with words and char n-grams ensemble                    complete  0.84033                    
submission_lr.csv                    2020-06-30 10:57:02  Text Classifier using logistic regression with words and char n-grams  complete  0.78945                    
submission.csv                       2020-06-28 05:05:33  Ensemble of ULMFiT and Roberta Predictions                             complete  0.83573                    
submission.csv                       2020-06-28 04:47:56  Averaging ULMFiT and Roberta Predictions                               complete  0.00000                    
submission.csv                       2020-06-28 04:34:00  Roberta model submission 3                                             complete  0.83328                    
submission.csv                       2020-06-28 04:25:41                                                                         complete  0.83481                    
submission.csv                       2020-06-28 03:27:17  Using Transformers Roberta Base                                        complete  0.83573                    
submission.csv                       2020-06-26 12:51:07  2nd submission                                                         complete  0.80447                    
submission.csv                       2020-06-23 13:41:52  Fastai Style                                                           complete  0.79865                    
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The above submission acheived a score of ~0.81 on the competition leaderboard.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion">
<a class="anchor" href="#Conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion<a class="anchor-link" href="#Conclusion"> </a>
</h2>
<p>In this post we have seen how to build a fine-tuned language model for any textual data corpus which captures the semantics of the dataset. The encoder part of this fine-tuned language model was then used to build a pretty-decent text classifier that can identify tweets describing a natural disaster.</p>
<p>In the upcoming posts, I would try to delve deeper into building advanced NLP models like the Transformer architecture and researching other famous research papers in the domain of NLP.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="References">
<a class="anchor" href="#References" aria-hidden="true"><span class="octicon octicon-link"></span></a>References<a class="anchor-link" href="#References"> </a>
</h2>
<ul>
<li>Fastai <a href="https://docs.fast.ai">Documentation</a>
</li>
<li>Fastbook Chapter 10: <a href="https://github.com/fastai/fastbook/blob/master/10_nlp.ipynb">NLP Deep Dive</a>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="harish3110/through-tinted-lenses"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/through-tinted-lenses/natural%20language%20processing/sentiment%20analysis/2021/10/27/Introduction-to-NLP-using-Fastai.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/through-tinted-lenses/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/through-tinted-lenses/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/through-tinted-lenses/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Immerse into the lesser known.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/harish3110" target="_blank" title="harish3110"><svg class="svg-icon grey"><use xlink:href="/through-tinted-lenses/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/harish3110" target="_blank" title="harish3110"><svg class="svg-icon grey"><use xlink:href="/through-tinted-lenses/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
